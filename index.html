<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§åŠ¨æ€ç³»ç»Ÿ</title>
    <style>
        body { font-family: sans-serif; margin: 40px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .auth-section, .main-app { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        input, textarea, button { display: block; margin: 10px 0; padding: 10px; width: 100%; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .dynamic-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background-color: #dff0d8; color: #3c763d; }
        .error { background-color: #f2dede; color: #a94442; }
        #imageGallery img { max-width: 200px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¢ ç­çº§åŠ¨æ€ç³»ç»Ÿ</h1>
        <p>å…±äº«ç­çº§ç‚¹æ»´ï¼Œè®°å½•æˆé•¿è¶³è¿¹</p>

        <!-- èº«ä»½éªŒè¯åŒºåŸŸ -->
        <div id="authSection" class="auth-section">
            <h3>ğŸ” æˆå‘˜éªŒè¯</h3>
            <p>è¯·è¾“å…¥ç®¡ç†å¯†ç ä»¥å‘å¸ƒå’Œç®¡ç†åŠ¨æ€ï¼š</p>
            <input type="password" id="adminPasswordInput" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button onclick="verifyPassword()">è¿›å…¥ç³»ç»Ÿ</button>
            <p id="loginMessage" class="message"></p>
        </div>

        <!-- ä¸»åŠŸèƒ½åŒºåŸŸï¼ˆéªŒè¯åæ˜¾ç¤ºï¼‰ -->
        <div id="mainApp" class="main-app" style="display: none;">
            <h3>âœ¨ å‘å¸ƒæ–°åŠ¨æ€</h3>
            <textarea id="newContent" placeholder="åˆ†äº«æ–°é²œäº‹..." rows="4"></textarea>
            <input type="file" id="imageUpload" accept="image/*">
            <button onclick="submitDynamic()">å‘å¸ƒåŠ¨æ€</button>
            <p id="statusMessage" class="message"></p>

            <hr>

            <h3>ğŸ“‹ åŠ¨æ€åˆ—è¡¨</h3>
            <button onclick="loadDynamics()">åˆ·æ–°åŠ¨æ€</button>
            <div id="dynamicsList"></div>
        </div>
    </div>

    <script>
        // === ğŸ”§ æ ¸å¿ƒé…ç½®åŒº - å¼€å§‹ ===
        // ï¼ï¼ï¼é‡è¦ï¼šè¯·ä¿®æ”¹ä»¥ä¸‹é…ç½®ä¸ºæ‚¨è‡ªå·±çš„ä¿¡æ¯ ï¼ï¼ï¼
        const CONFIG = {
            GITHUB_USERNAME: 'LGSlgs15915395519', // æ‚¨çš„ GitHub ç”¨æˆ·å
            REPOSITORY_NAME: 'lqdjglxt',          // æ‚¨çš„ä»“åº“å
            GITHUB_TOKEN: 'ghp_xxxxxxxxxxxxxxxxxxxx', // æ‚¨çš„ä¸ªäººè®¿é—®ä»¤ç‰Œï¼ˆPATï¼‰
            DATA_FILE: 'class_dynamics.json',      // å­˜å‚¨åŠ¨æ€æ•°æ®çš„æ–‡ä»¶å
            // ç³»ç»Ÿç®¡ç†å¯†ç ï¼ˆåˆå§‹ä¸º123456789ï¼Œå¯åœ¨ç³»ç»Ÿå†…ä¿®æ”¹ï¼‰
            ADMIN_PASSWORD: '123456789',
            // å¯†ç é‡ç½®å¯†é’¥ï¼ˆå¿˜è®°å¯†ç æ—¶ä½¿ç”¨ï¼‰
            PASSWORD_RESET_KEY: 'SZ15915395519'
        };
        // GitHub API åŸºç¡€åœ°å€
        const API_BASE = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPOSITORY_NAME}/contents`;
        // === ğŸ”§ æ ¸å¿ƒé…ç½®åŒº - ç»“æŸ ===

        // å…¨å±€çŠ¶æ€
        let isAuthenticated = false;

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, text, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = isError ? 'message error' : 'message success';
            element.style.display = 'block';
        }

        // éªŒè¯å¯†ç 
        async function verifyPassword() {
            const inputPassword = document.getElementById('adminPasswordInput').value;
            
            if (inputPassword === CONFIG.ADMIN_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                showMessage('loginMessage', 'éªŒè¯æˆåŠŸï¼', false);
                await loadDynamics(); // ç™»å½•ååŠ è½½åŠ¨æ€
            } else {
                showMessage('loginMessage', 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ï¼', true);
            }
        }

        // æäº¤åŠ¨æ€åˆ° GitHub
        async function submitDynamic() {
            if (!isAuthenticated) {
                showMessage('statusMessage', 'è¯·å…ˆéªŒè¯èº«ä»½ï¼', true);
                return;
            }

            const content = document.getElementById('newContent').value.trim();
            const imageFile = document.getElementById('imageUpload').files[0];

            if (!content && !imageFile) {
                showMessage('statusMessage', 'è¯·è¾“å…¥å†…å®¹æˆ–é€‰æ‹©å›¾ç‰‡ï¼', true);
                return;
            }

            showMessage('statusMessage', 'å‘å¸ƒä¸­...', false);

            try {
                // 1. è·å–ç°æœ‰çš„åŠ¨æ€æ•°æ®æ–‡ä»¶
                const { existingData, fileSha } = await getExistingDataFile();
                
                // 2. å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆå¦‚æœæœ‰ï¼‰
                let imageUrl = null;
                if (imageFile) {
                    imageUrl = await uploadImage(imageFile);
                }

                // 3. åˆ›å»ºæ–°åŠ¨æ€å¯¹è±¡
                const newDynamic = {
                    id: Date.now(),
                    content: content,
                    imageUrl: imageUrl,
                    timestamp: new Date().toISOString(),
                    author: 'ç­çº§æˆå‘˜' // å¯ä»¥æ‰©å±•ä¸ºè¾“å…¥ä½œè€…å
                };

                // 4. å°†æ–°åŠ¨æ€æ·»åŠ åˆ°æ•°æ®åˆ—è¡¨
                existingData.push(newDynamic);

                // 5. æ›´æ–° GitHub ä¸Šçš„æ•°æ®æ–‡ä»¶
                await updateDataFile(existingData, fileSha, `æ·»åŠ æ–°åŠ¨æ€: ${content.substring(0, 20)}...`);

                // 6. æ¸…ç†è¡¨å•å¹¶æ›´æ–°ç•Œé¢
                document.getElementById('newContent').value = '';
                document.getElementById('imageUpload').value = '';
                showMessage('statusMessage', 'åŠ¨æ€å‘å¸ƒæˆåŠŸï¼', false);
                
                // é‡æ–°åŠ è½½åŠ¨æ€åˆ—è¡¨
                await loadDynamics();

            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                showMessage('statusMessage', 'å‘å¸ƒå¤±è´¥: ' + error.message, true);
            }
        }

        // è·å–ç°æœ‰çš„æ•°æ®æ–‡ä»¶
        async function getExistingDataFile() {
            try {
                const response = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`, {
                    headers: {
                        'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Class-Dynamics-App'
                    }
                });

                if (response.status === 404) {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ•°ç»„
                    return { existingData: [], fileSha: null };
                }
                
                if (!response.ok) {
                    throw new Error(`è·å–æ•°æ®å¤±è´¥: ${response.status}`);
                }

                const fileInfo = await response.json();
                const content = JSON.parse(atob(fileInfo.content));
                return { existingData: content, fileSha: fileInfo.sha };

            } catch (error) {
                throw new Error('è·å–ç°æœ‰æ•°æ®æ—¶å‡ºé”™: ' + error.message);
            }
        }

        // ä¸Šä¼ å›¾ç‰‡åˆ° GitHub
        async function uploadImage(file) {
            const timestamp = Date.now();
            const filename = `images/dynamic_${timestamp}.${file.name.split('.').pop()}`;
            const reader = new FileReader();

            return new Promise((resolve, reject) => {
                reader.onload = async function(e) {
                    try {
                        const base64Content = e.target.result.split(',')[1];
                        
                        const response = await fetch(`${API_BASE}/${filename}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/vnd.github.v3+json',
                                'User-Agent': 'Class-Dynamics-App'
                            },
                            body: JSON.stringify({
                                message: `ä¸Šä¼ åŠ¨æ€å›¾ç‰‡: ${filename}`,
                                content: base64Content
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                        }

                        // è¿”å›å›¾ç‰‡çš„è®¿é—®åœ°å€ï¼ˆé€šè¿‡ GitHub Pagesï¼‰
                        resolve(`https://${CONFIG.GITHUB_USERNAME}.github.io/${CONFIG.REPOSITORY_NAME}/${filename}`);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // æ›´æ–°æ•°æ®æ–‡ä»¶
        async function updateDataFile(data, fileSha, commitMessage) {
            const response = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'Class-Dynamics-App'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: btoa(JSON.stringify(data, null, 2)),
                    sha: fileSha
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'æ›´æ–°æ•°æ®æ–‡ä»¶å¤±è´¥');
            }
            return await response.json();
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºåŠ¨æ€
        async function loadDynamics() {
            try {
                const response = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Class-Dynamics-App'
                    }
                });

                if (response.status === 404) {
                    document.getElementById('dynamicsList').innerHTML = '<p>è¿˜æ²¡æœ‰åŠ¨æ€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>';
                    return;
                }

                if (!response.ok) {
                    throw new Error('åŠ è½½åŠ¨æ€å¤±è´¥');
                }

                const fileInfo = await response.json();
                const dynamics = JSON.parse(atob(fileInfo.content));

                if (dynamics.length === 0) {
                    document.getElementById('dynamicsList').innerHTML = '<p>æš‚æ— åŠ¨æ€</p>';
                    return;
                }

                // æŒ‰æ—¶é—´å€’åºæ’åˆ—
                dynamics.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                let html = '';
                dynamics.forEach(dynamic => {
                    const date = new Date(dynamic.timestamp).toLocaleString('zh-CN');
                    html += `
                        <div class="dynamic-item">
                            <div class="dynamic-content">
                                <p>${dynamic.content || ''}</p>
                                ${dynamic.imageUrl ? `<img src="${dynamic.imageUrl}" alt="åŠ¨æ€å›¾ç‰‡" style="max-width: 300px;">` : ''}
                            </div>
                            <div class="dynamic-meta">
                                <small>ğŸ“… ${date} | ğŸ‘¤ ${dynamic.author}</small>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('dynamicsList').innerHTML = html;

            } catch (error) {
                console.error('åŠ è½½åŠ¨æ€å¤±è´¥:', error);
                document.getElementById('dynamicsList').innerHTML = '<p>åŠ è½½åŠ¨æ€å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
            }
        }

        // é¡µé¢åŠ è½½æ—¶å°è¯•åŠ è½½åŠ¨æ€ï¼ˆæ— éœ€éªŒè¯å³å¯æŸ¥çœ‹ï¼‰
        window.addEventListener('DOMContentLoaded', function() {
            loadDynamics();
        });
    </script>
</body>
</html>