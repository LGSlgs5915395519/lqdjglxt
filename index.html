<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§åŠ¨æ€ï½œå†…éƒ¨ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --danger: #f72585;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; color: var(--dark); }
        .container { max-width: 900px; margin: 20px auto; }
        header { text-align: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 16px; box-shadow: var(--card-shadow); }
        h1 { color: var(--secondary); font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { color: #6c757d; font-size: 1.1rem; }
        .card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: var(--card-shadow); border: none; }
        .auth-section input, .publish-section input, .publish-section textarea { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: all 0.3s; }
        .auth-section input:focus, .publish-section input:focus, .publish-section textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2); }
        .btn { display: inline-block; padding: 12px 28px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-align: center; text-decoration: none; }
        .btn:hover { background: var(--secondary); transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15); }
        .btn-sm { padding: 8px 18px; font-size: 14px; }
        .btn-block { display: block; width: 100%; }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .message { padding: 12px 18px; border-radius: 10px; margin: 15px 0; display: none; }
        .message.error { background: #ffebee; color: #c62828; border-left: 5px solid #c62828; display: block; }
        .message.success { background: #e8f5e9; color: #2e7d32; border-left: 5px solid #2e7d32; display: block; }
        .post { border-left: 5px solid var(--primary); padding: 20px; margin-bottom: 20px; background: var(--light); border-radius: 0 12px 12px 0; }
        .post h4 { color: var(--secondary); margin-bottom: 8px; font-size: 1.3rem; }
        .post p { line-height: 1.6; margin-bottom: 12px; }
        .post img { max-width: 100%; max-height: 400px; border-radius: 10px; margin: 10px 0; border: 1px solid #ddd; }
        .meta { font-size: 0.9em; color: #6c757d; display: flex; justify-content: space-between; border-top: 1px dashed #dee2e6; padding-top: 10px; margin-top: 15px; }
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; align-items: center; }
        .icon { margin-right: 8px; }
        #postsContainer { min-height: 200px; }
        .loading { text-align: center; padding: 40px; color: #6c757d; }
        footer { text-align: center; margin-top: 30px; color: #6c757d; font-size: 0.9em; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-newspaper icon"></i>ç­çº§åŠ¨æ€ç³»ç»Ÿ</h1>
            <p class="subtitle">è®°å½•æˆé•¿ç‚¹æ»´ï¼Œå…±äº«ç­çº§æ—¶å…‰</p>
        </header>

        <!-- å¯†ç éªŒè¯åŒºåŸŸ -->
        <section id="authSection" class="card auth-section">
            <h3><i class="fas fa-lock icon"></i>å†…éƒ¨æˆå‘˜éªŒè¯</h3>
            <p>è¯·è¾“å…¥ç®¡ç†å¯†ç ä»¥è¿›å…¥å‘å¸ƒç•Œé¢ï¼š</p>
            <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ç®¡ç†å¯†ç ">
            <button onclick="verifyPassword()" class="btn btn-block">éªŒè¯èº«ä»½å¹¶è¿›å…¥</button>
            <div id="loginMessage" class="message"></div>
        </section>

        <!-- å‘å¸ƒåŠ¨æ€åŒºåŸŸï¼ˆéªŒè¯åæ˜¾ç¤ºï¼‰ -->
        <section id="publishSection" class="card publish-section hidden">
            <h3><i class="fas fa-edit icon"></i>å‘å¸ƒæ–°åŠ¨æ€</h3>
            <input type="text" id="postTitle" placeholder="ä¸ºæ‚¨çš„åŠ¨æ€èµ·ä¸ªæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰">
            <textarea id="postContent" placeholder="åˆ†äº«æ‚¨æƒ³è¯´çš„å†…å®¹..." rows="4"></textarea>
            <div class="flex">
                <input type="file" id="imageUpload" accept="image/*" style="flex-grow: 1;">
                <button onclick="clearForm()" class="btn btn-danger btn-sm"><i class="fas fa-times"></i> æ¸…ç©º</button>
            </div>
            <div class="flex" style="margin-top: 15px;">
                <button onclick="publishPost()" class="btn btn-success" style="flex-grow: 1;"><i class="fas fa-paper-plane"></i> å‘å¸ƒåŠ¨æ€</button>
                <button onclick="logout()" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> é€€å‡º</button>
            </div>
            <div id="statusMessage" class="message"></div>
        </section>

        <!-- åŠ¨æ€å±•ç¤ºåŒºåŸŸ -->
        <section class="card">
            <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;"><i class="fas fa-list icon"></i>æœ€æ–°åŠ¨æ€</h3>
                <button onclick="loadPosts()" class="btn btn-sm"><i class="fas fa-sync-alt"></i> åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div id="postsContainer">
                <p class="loading"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½åŠ¨æ€...</p>
            </div>
        </section>

        <footer>
            <p>æœ¬ç³»ç»Ÿç”±ç­çº§æŠ€æœ¯éƒ¨æä¾›æ”¯æŒ | æ•°æ®é€šè¿‡ GitHub å®‰å…¨å­˜å‚¨ | Â© 2023 ç­çº§åŠ¨æ€</p>
        </footer>
    </div>

    <script>
        // ==================== ã€æ‚¨çš„é…ç½®åŒºåŸŸã€‘ ====================
        // ï¼ï¼ï¼è¯·åŠ¡å¿…ä¿®æ”¹ä»¥ä¸‹ä¿¡æ¯ä¸ºæ‚¨è‡ªå·±çš„ ï¼ï¼ï¼
        const CONFIG = {
            GITHUB_USERNAME: 'LGSlgs15915395519',     // æ‚¨çš„ GitHub ç”¨æˆ·å
            REPOSITORY_NAME: 'lqdjglxt',              // æ‚¨çš„ä»“åº“å
            GITHUB_TOKEN: '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', // æ‚¨çš„ GitHub ä¸ªäººè®¿é—®ä»¤ç‰Œ (PAT)
            DATA_FILE: 'class_posts.json',            // å­˜å‚¨æ•°æ®çš„æ–‡ä»¶å
            ADMIN_PASSWORD: '123456789'               // ç®¡ç†å¯†ç 
        };
        // ==========================================================

        const API_BASE = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPOSITORY_NAME}/contents`;
        let isAuthenticated = false;

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, text, isError = false) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = isError ? 'message error' : 'message success';
        }

        // 1. å¯†ç éªŒè¯
        function verifyPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === CONFIG.ADMIN_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('publishSection').classList.remove('hidden');
                showMessage('loginMessage', 'âœ… éªŒè¯æˆåŠŸï¼ç®¡ç†åŠŸèƒ½å·²è§£é”ã€‚', false);
                loadPosts();
            } else {
                showMessage('loginMessage', 'âŒ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚', true);
            }
        }

        // 2. å‘å¸ƒåŠ¨æ€ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
        async function publishPost() {
            if (!isAuthenticated) {
                showMessage('statusMessage', 'è¯·å…ˆéªŒè¯èº«ä»½ï¼', true);
                return;
            }
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const imageFile = document.getElementById('imageUpload').files[0];
            if (!title && !content && !imageFile) {
                showMessage('statusMessage', 'è¯·å¡«å†™å†…å®¹æˆ–é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚', true);
                return;
            }
            showMessage('statusMessage', 'â³ å‘å¸ƒä¸­ï¼Œè¯·ç¨å€™...', false);
            try {
                // 2.1 è·å–ç°æœ‰æ•°æ®
                const { data: existingPosts, sha } = await fetchDataFile();
                // 2.2 å¤„ç†å›¾ç‰‡ä¸Šä¼ 
                let imageUrl = null;
                if (imageFile) imageUrl = await uploadImageToGitHub(imageFile);
                // 2.3 åˆ›å»ºæ–°åŠ¨æ€å¯¹è±¡
                const newPost = {
                    id: Date.now(),
                    title: title || 'æ— æ ‡é¢˜',
                    content: content,
                    imageUrl: imageUrl,
                    time: new Date().toLocaleString('zh-CN')
                };
                // 2.4 æ·»åŠ åˆ°åˆ—è¡¨å¹¶æ›´æ–°
                existingPosts.unshift(newPost);
                await updateDataFile(existingPosts, sha, `æ·»åŠ æ–°åŠ¨æ€: ${title}`);
                // 2.5 æˆåŠŸå¤„ç†
                showMessage('statusMessage', 'ğŸ‰ åŠ¨æ€å‘å¸ƒæˆåŠŸï¼', false);
                clearForm();
                await loadPosts();
            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                showMessage('statusMessage', `å‘å¸ƒå¤±è´¥: ${error.message}`, true);
            }
        }

        // 3. ä»GitHubè·å–æ•°æ®æ–‡ä»¶
        async function fetchDataFile() {
            const url = `${API_BASE}/${CONFIG.DATA_FILE}`;
            const headers = { 'Authorization': `token ${CONFIG.GITHUB_TOKEN}` };
            const res = await fetch(url, { headers });
            if (res.status === 404) return { data: [], sha: null };
            if (!res.ok) throw new Error(`è·å–æ•°æ®å¤±è´¥ (HTTP ${res.status})`);
            const file = await res.json();
            return { data: JSON.parse(atob(file.content)), sha: file.sha };
        }

        // 4. ä¸Šä¼ å›¾ç‰‡åˆ°GitHub
        async function uploadImageToGitHub(file) {
            const filename = `images/post_${Date.now()}.${file.name.split('.').pop()}`;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Content = e.target.result.split(',')[1];
                    const res = await fetch(`${API_BASE}/${filename}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `ä¸Šä¼ å›¾ç‰‡: ${filename}`,
                            content: base64Content
                        })
                    });
                    if (!res.ok) reject(new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥'));
                    resolve(`https://${CONFIG.GITHUB_USERNAME}.github.io/${CONFIG.REPOSITORY_NAME}/${filename}`);
                };
                reader.readAsDataURL(file);
            });
        }

        // 5. æ›´æ–°æ•°æ®æ–‡ä»¶åˆ°GitHub
        async function updateDataFile(data, sha, commitMsg) {
            const res = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMsg,
                    content: btoa(JSON.stringify(data, null, 2)),
                    sha: sha
                })
            });
            if (!res.ok) throw new Error('æ›´æ–°åˆ°GitHubå¤±è´¥');
        }

        // 6. åŠ è½½å¹¶æ˜¾ç¤ºåŠ¨æ€åˆ—è¡¨
        async function loadPosts() {
            const container = document.getElementById('postsContainer');
            container.innerHTML = '<p class="loading"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</p>';
            try {
                const res = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`);
                if (res.status === 404) {
                    container.innerHTML = '<p>ğŸ“­ è¿˜æ²¡æœ‰åŠ¨æ€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>';
                    return;
                }
                if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
                const file = await res.json();
                const posts = JSON.parse(atob(file.content));
                if (posts.length === 0) {
                    container.innerHTML = '<p>ğŸ“­ æš‚æ— åŠ¨æ€ã€‚</p>';
                    return;
                }
                let html = '';
                posts.forEach(post => {
                    html += `
                        <div class="post">
                            <h4>${post.title}</h4>
                            <p>${post.content.replace(/\n/g, '<br>')}</p>
                            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="åŠ¨æ€å›¾ç‰‡">` : ''}
                            <div class="meta">
                                <span>ğŸ• ${post.time}</span>
                                <span>ğŸ“Œ ID: ${post.id}</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<p class="error">âŒ åŠ è½½åŠ¨æ€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°ã€‚</p>';
            }
        }

        // è¾…åŠ©å‡½æ•°
        function clearForm() {
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            document.getElementById('imageUpload').value = '';
            showMessage('statusMessage', '', false);
        }
        function logout() {
            isAuthenticated = false;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('publishSection').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            showMessage('loginMessage', 'æ‚¨å·²å®‰å…¨é€€å‡ºã€‚', false);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–åŠ¨æ€
        window.addEventListener('DOMContentLoaded', loadPosts);
    </script>
</body>
</html>