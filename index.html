<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§åŠ¨æ€å‘¨æŠ¥ç³»ç»Ÿ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: #f5f5f5; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { margin-bottom: 15px; color: #2c3e50; }
        .auth-box, .publish-box, .feed { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #3498db; }
        input, textarea, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        button { background: #3498db; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #2980b9; }
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; text-align: center; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .post { background: white; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #e1e8ed; }
        .post img { max-width: 100%; height: auto; border-radius: 5px; margin-top: 10px; }
        .meta { color: #7f8c8d; font-size: 0.9em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ecf0f1; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¢ ç­çº§åŠ¨æ€å‘¨æŠ¥ç³»ç»Ÿ</h1>
        
        <!-- å¯†ç éªŒè¯åŒºåŸŸ -->
        <div id="authBox" class="auth-box">
            <h3>ğŸ” å†…éƒ¨æˆå‘˜éªŒè¯</h3>
            <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥ç®¡ç†å¯†ç ">
            <button onclick="verifyPassword()">è¿›å…¥ç³»ç»Ÿ</button>
            <div id="loginMessage" class="message"></div>
        </div>

        <!-- å‘å¸ƒåŠ¨æ€åŒºåŸŸï¼ˆéªŒè¯åæ˜¾ç¤ºï¼‰ -->
        <div id="publishBox" class="publish-box hidden">
            <h3>âœ¨ å‘å¸ƒæ–°åŠ¨æ€</h3>
            <input type="text" id="postTitle" placeholder="è¯·è¾“å…¥åŠ¨æ€æ ‡é¢˜">
            <textarea id="postContent" placeholder="è¯·è¾“å…¥åŠ¨æ€å†…å®¹" rows="3"></textarea>
            <input type="file" id="imageUpload" accept="image/*">
            <button onclick="publishPost()">å‘å¸ƒåŠ¨æ€</button>
            <div id="statusMessage" class="message"></div>
        </div>

        <!-- åŠ¨æ€å±•ç¤ºåŒºåŸŸ -->
        <div class="feed">
            <h3>ğŸ“‹ åŠ¨æ€åˆ—è¡¨ <button onclick="loadPosts()" style="width: auto; padding: 5px 10px;">åˆ·æ–°</button></h3>
            <div id="postsContainer"></div>
        </div>
    </div>

    <script>
        // ==================== é…ç½®åŒºåŸŸ ====================
        // ã€é‡è¦ã€‘è¯·ä¿®æ”¹ä»¥ä¸‹ä¿¡æ¯ä¸ºæ‚¨è‡ªå·±çš„ï¼
        const CONFIG = {
            GITHUB_USERNAME: 'LGSlgs15915395519',     // æ‚¨çš„GitHubç”¨æˆ·å
            REPOSITORY_NAME: 'lqdjglxt',              // æ‚¨çš„ä»“åº“å
            GITHUB_TOKEN: 'ghp_xxxxxxxxxxxxxxxxxxxx', // æ‚¨çš„GitHub Token
            DATA_FILE: 'posts.json',                   // æ•°æ®æ–‡ä»¶åï¼ˆä¸ç”¨æ”¹ï¼‰
            ADMIN_PASSWORD: '123456789'               // ç®¡ç†å¯†ç ï¼ˆå¯ä»¥æ”¹ï¼‰
        };
        // ==================================================

        const API_BASE = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPOSITORY_NAME}/contents`;
        let isAuthenticated = false;

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, text, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = isError ? 'message error' : 'message success';
            element.style.display = 'block';
        }

        // éªŒè¯å¯†ç 
        function verifyPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === CONFIG.ADMIN_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('authBox').classList.add('hidden');
                document.getElementById('publishBox').classList.remove('hidden');
                showMessage('loginMessage', 'éªŒè¯æˆåŠŸï¼', false);
                loadPosts();
            } else {
                showMessage('loginMessage', 'å¯†ç é”™è¯¯ï¼', true);
            }
        }

        // å‘å¸ƒåŠ¨æ€
        async function publishPost() {
            if (!isAuthenticated) {
                showMessage('statusMessage', 'è¯·å…ˆéªŒè¯èº«ä»½ï¼', true);
                return;
            }

            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const imageFile = document.getElementById('imageUpload').files[0];

            if (!title && !content && !imageFile) {
                showMessage('statusMessage', 'è¯·è¾“å…¥æ ‡é¢˜ã€å†…å®¹æˆ–é€‰æ‹©å›¾ç‰‡ï¼', true);
                return;
            }

            showMessage('statusMessage', 'å‘å¸ƒä¸­...', false);

            try {
                // 1. è·å–ç°æœ‰æ•°æ®
                const { existingPosts, fileSha } = await getDataFile();
                
                // 2. å¤„ç†å›¾ç‰‡ä¸Šä¼ 
                let imageUrl = null;
                if (imageFile) {
                    imageUrl = await uploadImage(imageFile);
                }

                // 3. åˆ›å»ºæ–°åŠ¨æ€
                const newPost = {
                    id: Date.now(),
                    title: title || 'æ— æ ‡é¢˜',
                    content: content,
                    imageUrl: imageUrl,
                    timestamp: new Date().toISOString()
                };

                // 4. æ·»åŠ åˆ°æ•°æ®åˆ—è¡¨
                existingPosts.unshift(newPost); // æ–°å†…å®¹æ”¾åœ¨æœ€å‰é¢

                // 5. æ›´æ–°åˆ°GitHub
                await updateDataFile(existingPosts, fileSha, `å‘å¸ƒæ–°åŠ¨æ€: ${title}`);
                
                // 6. æ¸…ç†è¡¨å•
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
                document.getElementById('imageUpload').value = '';
                
                showMessage('statusMessage', 'å‘å¸ƒæˆåŠŸï¼', false);
                loadPosts();

            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                showMessage('statusMessage', 'å‘å¸ƒå¤±è´¥: ' + error.message, true);
            }
        }

        // è·å–æ•°æ®æ–‡ä»¶
        async function getDataFile() {
            try {
                const response = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`, {
                    headers: { 'Authorization': `token ${CONFIG.GITHUB_TOKEN}` }
                });

                if (response.status === 404) {
                    return { existingPosts: [], fileSha: null };
                }
                
                if (!response.ok) throw new Error('è·å–æ•°æ®å¤±è´¥');
                
                const fileInfo = await response.json();
                const content = JSON.parse(atob(fileInfo.content));
                return { existingPosts: content, fileSha: fileInfo.sha };

            } catch (error) {
                throw new Error('è·å–æ•°æ®æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }

        // ä¸Šä¼ å›¾ç‰‡
        async function uploadImage(file) {
            const filename = `images/${Date.now()}_${file.name}`;
            const reader = new FileReader();
            
            return new Promise((resolve, reject) => {
                reader.onload = async function(e) {
                    try {
                        const base64Content = e.target.result.split(',')[1];
                        const response = await fetch(`${API_BASE}/${filename}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `ä¸Šä¼ å›¾ç‰‡: ${filename}`,
                                content: base64Content
                            })
                        });

                        if (!response.ok) throw new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                        resolve(`https://${CONFIG.GITHUB_USERNAME}.github.io/${CONFIG.REPOSITORY_NAME}/${filename}`);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // æ›´æ–°æ•°æ®æ–‡ä»¶
        async function updateDataFile(data, sha, message) {
            const response = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    content: btoa(JSON.stringify(data, null, 2)),
                    sha: sha
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'æ›´æ–°å¤±è´¥');
            }
        }

        // åŠ è½½å¹¶å±•ç¤ºåŠ¨æ€
        async function loadPosts() {
            const container = document.getElementById('postsContainer');
            container.innerHTML = '<p>åŠ è½½ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`);
                
                if (response.status === 404) {
                    container.innerHTML = '<p>è¿˜æ²¡æœ‰åŠ¨æ€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>';
                    return;
                }
                
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const fileInfo = await response.json();
                const posts = JSON.parse(atob(fileInfo.content));

                if (posts.length === 0) {
                    container.innerHTML = '<p>æš‚æ— åŠ¨æ€</p>';
                    return;
                }

                let html = '';
                posts.forEach(post => {
                    const date = new Date(post.timestamp).toLocaleString('zh-CN');
                    html += `
                        <div class="post">
                            <h4>${post.title}</h4>
                            <p>${post.content.replace(/\n/g, '<br>')}</p>
                            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="åŠ¨æ€å›¾ç‰‡">` : ''}
                            <div class="meta">ğŸ“… ${date}</div>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = '<p>åŠ è½½åŠ¨æ€å¤±è´¥</p>';
            }
        }

        // é¡µé¢åŠ è½½æ—¶å°è¯•åŠ è½½åŠ¨æ€
        window.addEventListener('DOMContentLoaded', loadPosts);
    </script>
</body>
</html>