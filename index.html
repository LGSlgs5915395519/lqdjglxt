<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§åŠ¨æ€ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); overflow: hidden; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 40px; text-align: center; }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { font-size: 1.1em; opacity: 0.9; }
        .card { padding: 25px; margin: 0; border-bottom: 1px solid #eee; }
        .card:last-of-type { border-bottom: none; }
        h3 { color: #333; margin-bottom: 20px; font-size: 1.4em; }
        input, textarea, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 8px; font-size: 16px; }
        input, textarea { border: 2px solid #e1e5e9; background: #f8f9fa; transition: all 0.3s; }
        input:focus, textarea:focus { outline: none; border-color: #667eea; background: white; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .post { background: #f8fafc; border-left: 4px solid #667eea; padding: 20px; margin-bottom: 20px; border-radius: 0 8px 8px 0; }
        .post img { max-width: 100%; max-height: 300px; border-radius: 8px; margin: 10px 0; border: 1px solid #ddd; }
        .meta { color: #718096; font-size: 0.9em; margin-top: 10px; display: flex; justify-content: space-between; }
        .hidden { display: none !important; }
        .message { padding: 12px 18px; border-radius: 8px; margin: 10px 0; }
        .error { background: #fed7d7; color: #c53030; border-left: 4px solid #e53e3e; }
        .success { background: #c6f6d5; color: #22543d; border-left: 4px solid #38a169; }
        .info { background: #bee3f8; color: #2c5282; border-left: 4px solid #4299e1; }
        #postsContainer { min-height: 200px; }
    </style>
    <!-- å…³é”®ï¼šå¼•å…¥å¤–éƒ¨é…ç½®æ–‡ä»¶ï¼Œå¯†é’¥åœ¨è¿™é‡Œé¢ -->
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ« ç­çº§åŠ¨æ€ç³»ç»Ÿ</h1>
            <p class="subtitle">å®‰å…¨ã€å®æ—¶ã€ä¾¿æ·çš„ç­çº§ä¿¡æ¯ä¸­å¿ƒ</p>
        </header>

        <div id="authSection" class="card">
            <h3>ğŸ” å†…éƒ¨æˆå‘˜éªŒè¯</h3>
            <p>è¯·è¾“å…¥ç®¡ç†å¯†ç ï¼Œè§£é”å‘å¸ƒåŠŸèƒ½ï¼š</p>
            <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥ç®¡ç†å¯†ç ">
            <button onclick="verifyPassword()">éªŒè¯èº«ä»½å¹¶è¿›å…¥</button>
            <div id="loginMessage" class="message"></div>
        </div>

        <div id="mainApp" class="card hidden">
            <h3>âœï¸ å‘å¸ƒæ–°åŠ¨æ€</h3>
            <input type="text" id="postTitle" placeholder="åŠ¨æ€æ ‡é¢˜ï¼ˆå¯é€‰ï¼Œå¡«å†™æ›´æ¸…æ™°ï¼‰">
            <textarea id="postContent" placeholder="åˆ†äº«æ‚¨æƒ³è¯´çš„å†…å®¹..." rows="4"></textarea>
            <div style="display: flex; gap: 10px; margin: 10px 0; align-items: center;">
                <input type="file" id="imageUpload" accept="image/*" style="flex-grow: 1;">
                <button onclick="clearForm()" style="width: auto; padding: 10px 20px; background: #a0aec0;">æ¸…ç©º</button>
            </div>
            <button onclick="publishPost()">ğŸš€ ç«‹å³å‘å¸ƒ</button>
            <div id="statusMessage" class="message"></div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ğŸ“° æœ€æ–°åŠ¨æ€</h3>
                <button onclick="loadPosts()" style="width: auto; padding: 8px 16px;">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div id="postsContainer">
                <p class="message info">æ­£åœ¨åŠ è½½åŠ¨æ€ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPOSITORY_NAME}/contents`;
        let isAuthenticated = false;

        function showMessage(elementId, text, type = 'info') {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message ${type}`;
        }

        function verifyPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === CONFIG.ADMIN_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showMessage('loginMessage', 'âœ… éªŒè¯æˆåŠŸï¼ç®¡ç†åŠŸèƒ½å·²è§£é”ã€‚', 'success');
                loadPosts();
            } else {
                showMessage('loginMessage', 'âŒ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚', 'error');
            }
        }

        async function publishPost() {
            if (!isAuthenticated) {
                showMessage('statusMessage', 'è¯·å…ˆéªŒè¯èº«ä»½ï¼', 'error');
                return;
            }
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const imageFile = document.getElementById('imageUpload').files[0];
            if (!title && !content && !imageFile) {
                showMessage('statusMessage', 'è¯·å¡«å†™å†…å®¹æˆ–é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚', 'error');
                return;
            }
            showMessage('statusMessage', 'â³ å‘å¸ƒä¸­ï¼Œè¯·ç¨å€™...', 'info');
            try {
                const { data: existingPosts, sha } = await fetchDataFile();
                let imageUrl = null;
                if (imageFile) imageUrl = await uploadImageToGitHub(imageFile);
                const newPost = {
                    id: Date.now(),
                    title: title || 'æ— æ ‡é¢˜',
                    content: content,
                    imageUrl: imageUrl,
                    time: new Date().toLocaleString('zh-CN')
                };
                existingPosts.unshift(newPost);
                await updateDataFile(existingPosts, sha, `å‘å¸ƒæ–°åŠ¨æ€: ${title}`);
                showMessage('statusMessage', 'ğŸ‰ åŠ¨æ€å‘å¸ƒæˆåŠŸï¼', 'success');
                clearForm();
                await loadPosts();
            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                showMessage('statusMessage', `å‘å¸ƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function fetchDataFile() {
            const url = `${API_BASE}/${CONFIG.DATA_FILE}`;
            const headers = { 'Authorization': `token ${CONFIG.GITHUB_TOKEN}` };
            const res = await fetch(url, { headers });
            if (res.status === 404) return { data: [], sha: null };
            if (!res.ok) throw new Error(`è·å–æ•°æ®å¤±è´¥ (HTTP ${res.status})`);
            const file = await res.json();
            return { data: JSON.parse(atob(file.content)), sha: file.sha };
        }

        async function uploadImageToGitHub(file) {
            const filename = `images/${Date.now()}_${file.name}`;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Content = e.target.result.split(',')[1];
                    const res = await fetch(`${API_BASE}/${filename}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${CONFIG.GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `ä¸Šä¼ å›¾ç‰‡: ${filename}`, content: base64Content })
                    });
                    if (!res.ok) reject(new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥'));
                    resolve(`https://${CONFIG.GITHUB_USERNAME}.github.io/${CONFIG.REPOSITORY_NAME}/${filename}`);
                };
                reader.readAsDataURL(file);
            });
        }

        async function updateDataFile(data, sha, commitMsg) {
            const res = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${CONFIG.GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: commitMsg,
                    content: btoa(JSON.stringify(data, null, 2)),
                    sha: sha
                })
            });
            if (!res.ok) throw new Error('æ›´æ–°åˆ°GitHubå¤±è´¥');
        }

        async function loadPosts() {
            const container = document.getElementById('postsContainer');
            try {
                const res = await fetch(`${API_BASE}/${CONFIG.DATA_FILE}`);
                if (res.status === 404) {
                    container.innerHTML = '<p class="message info">ğŸ“­ è¿˜æ²¡æœ‰åŠ¨æ€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>';
                    return;
                }
                if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
                const file = await res.json();
                const posts = JSON.parse(atob(file.content));
                if (posts.length === 0) {
                    container.innerHTML = '<p class="message info">ğŸ“­ æš‚æ— åŠ¨æ€ã€‚</p>';
                    return;
                }
                let html = '';
                posts.forEach(post => {
                    html += `
                        <div class="post">
                            <h4>${post.title}</h4>
                            <p>${post.content.replace(/\n/g, '<br>')}</p>
                            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="åŠ¨æ€å›¾ç‰‡">` : ''}
                            <div class="meta">
                                <span>ğŸ• ${post.time}</span>
                                <span>ğŸ“Œ ID: ${post.id}</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<p class="message error">âŒ åŠ è½½åŠ¨æ€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚</p>';
            }
        }

        function clearForm() {
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            document.getElementById('imageUpload').value = '';
            showMessage('statusMessage', '', 'info');
        }

        window.onload = loadPosts;
    </script>
</body>
</html>